# gitc コマンド要件定義書

## 概要
Git リポジトリのブランチクリーンアップを自動化するCLIツール「gitc」を開発する。
現在のブランチをデフォルトブランチに切り替え、最新状態にプルし、不要なローカルブランチを削除する一連の処理を1コマンドで実行する。

## 機能要件

### 1. 基本機能
- **コマンド名**: `gitc`
- **実行内容**: 以下の処理を自動実行
  1. デフォルトブランチの自動検出
  2. デフォルトブランチへの切り替え
  3. **必須**: `git fetch --all --prune` の実行（フラグなし、dry-runでも実行）
  4. リモートからの最新変更の取得（pull）
  5. 不要なローカルブランチの削除

### 2. デフォルトブランチ検出
- リモートリポジトリのデフォルトブランチを自動検出
- 検出方法の優先順位:
  1. `git symbolic-ref refs/remotes/origin/HEAD` の結果
  2. `main` ブランチの存在確認
  3. `master` ブランチの存在確認
  4. その他の一般的なデフォルトブランチ名（`develop`, `dev`など）

### 3. ブランチ削除対象
- **削除対象**: デフォルトブランチ以外のすべてのローカルブランチ
- **削除除外**: 
  - デフォルトブランチ
  - 現在チェックアウトしているブランチ（処理後はデフォルトブランチになるため実質的に同じ）

### 4. エラーハンドリング
- Gitリポジトリではないディレクトリで実行された場合のエラー処理
- リモートリポジトリにアクセスできない場合のエラー処理
- デフォルトブランチが検出できない場合のエラー処理
- プル処理でコンフリクトが発生した場合のエラー処理
- ブランチ削除でエラーが発生した場合の処理継続

## 技術要件

### 1. 開発言語・フレームワーク
- **言語**: Go
- **CLIフレームワーク**: Cobra

### 2. 外部依存
- Gitコマンドの実行環境が必要
- インターネット接続（リモートリポジトリへのアクセス用）

### 3. 動作環境
- Linux, macOS, Windows対応
- Go 1.19以上

## 非機能要件

### 1. ユーザビリティ
- 実行前に削除予定のブランチ一覧を表示
- 確認プロンプトの表示（オプションでスキップ可能）
- 進行状況の表示
- 処理結果のサマリー表示

### 2. セキュリティ
- 誤操作防止のための確認機能
- 重要なブランチの保護機能（設定可能）

### 3. 保守性
- 詳細なログ出力機能
- デバッグモードの提供
- 設定ファイルによるカスタマイズ対応

## コマンドオプション

### 基本オプション
- `-y, --yes`: 確認プロンプトをスキップ
- `-v, --verbose`: 詳細な実行ログを表示
- `--dry-run`: 実際の処理は行わず、実行予定の内容のみ表示
- `--help`: ヘルプ表示

### 高度なオプション
- `--default-branch <branch>`: デフォルトブランチを手動指定
- `--exclude <pattern>`: 削除から除外するブランチのパターン指定
- `--no-pull`: プル処理をスキップ
- `--force`: 強制実行（マージされていないブランチも削除）

## 実行例

```bash
# 基本実行
$ gitc

# 確認なしで実行
$ gitc -y

# ドライラン
$ gitc --dry-run

# 詳細ログ付きで実行
$ gitc -v

# 特定ブランチを除外して実行
$ gitc --exclude "feature/*" --exclude "hotfix/*"
```

## 期待される出力例

```
🔍 Detecting default branch...
✅ Default branch detected: main

📋 Branches to be deleted:
  - feature/user-auth
  - bugfix/login-issue
  - experimental/new-ui

❓ Do you want to continue? [y/N]: y

🔄 Switching to main branch...
⬇️  Pulling latest changes...
🗑️  Deleting local branches...
  ✅ Deleted: feature/user-auth
  ✅ Deleted: bugfix/login-issue
  ✅ Deleted: experimental/new-ui

🎉 Cleanup completed! Deleted 3 branches.
```

## 配布方法
- GitHub Releasesでバイナリ配布
- Go modulesとしてインストール可能
- Homebrewでのインストール対応（将来的に）

---

# Claude Code 開発タスクリスト

## 完了済みタスク ✅

### Phase 1: プロジェクト基盤構築
- [x] Go モジュール初期化
- [x] Cobra CLI依存関係追加
- [x] 基本ディレクトリ構造作成
- [x] .gitignore ファイル作成
- [x] README.md 基本構造作成

### Phase 2: コア機能実装
- [x] Git リポジトリ検証機能（テスト済み）
- [x] Git コマンド実行ヘルパー関数
- [x] エラーハンドリング基盤（テスト済み）
- [x] デフォルトブランチ検出機能
- [x] ブランチ操作機能
- [x] リモート操作機能

## 未実装タスクリスト 📋

### Phase 3: ユーザーが実際に使えるCLI 🖥️

#### 3.1 メインコマンド実装 ✅
- [x] `gitc` コマンドのメイン処理フロー実装
  - [x] テスト: メイン処理フローの正常系
  - [x] テスト: Git リポジトリでない場合のエラー
- [x] 処理手順の統合（検証→切替→プル→削除）
  - [x] テスト: 処理順序の確認
  - [x] テスト: 各ステップのエラーハンドリング

#### 3.2 基本CLIインターフェース ✅
**達成**: ユーザーがコマンドを打って確認できる状態（最小実装完了）

- [x] **Cobraコマンド統合**
  - [x] cmd/root.goでのフラグ定義
  - [x] git.ExecuteCleanupとの統合
  - [x] テスト: 基本コマンド実行
  
- [x] **必須フラグ実装**
  - [x] `--dry-run`: 安全確認用
  - [x] `--yes, -y`: 確認スキップ
  - [x] `--help`: ヘルプ表示（Cobra標準）

- [x] **基本的な出力表示**
  - [x] 実行結果の表示（削除ブランチ一覧）
  - [x] ドライランモードでの表示

#### 3.3 最優先: fetch処理の必須化 🚀 ✅ 完了
**目標**: `git fetch --all --prune` を必ず実行し、ドライランでも動作する

- [x] **ステップ1: cleanup.goの構造体からNoFetchフィールド削除** ⭐ 最重要
  - [x] CleanupOptionsからNoFetchフィールドを削除
  - [x] テスト: 構造体の変更確認

- [x] **ステップ2: fetch処理の必須化実装**
  - [x] cleanup.goでfetch処理を必須化（条件分岐なし）
  - [x] ドライランモードでもfetch実行するよう変更
  - [x] テスト: fetch処理の必須確認

- [x] **ステップ3: cmd/root.goからNoFetchオプション削除**
  - [x] flagNoFetch変数削除
  - [x] --no-fetchフラグ定義削除
  - [x] CleanupOptionsからNoFetchオプション削除
  - [x] テスト: フラグ削除確認

- [x] **ステップ4: 処理フロー確認**
  - [x] デフォルトブランチ切り替え → **必須fetch** → プル → 削除の順序
  - [x] ドライランでのfetch実行確認
  - [x] テスト: 更新された処理順序の確認

#### 3.4 追加機能（fetch必須化後）
- [ ] **詳細オプション**
  - [x] `--verbose, -v`: 詳細ログ表示 ✅ 完了
  - [ ] `--default-branch`: ブランチ手動指定
  - [ ] `--exclude`: 除外パターン

- [ ] **UI向上**
  - [ ] 絵文字付き進行状況表示
  - [ ] 確認プロンプト（--yesなしの場合）
  - [ ] カラー出力対応

- [ ] **フラグバリデーション**
  - [ ] 無効な組み合わせチェック
  - [ ] エラー時の適切なメッセージ

### Phase 4: 高度な機能 🚀

#### 4.1 追加オプション
- [ ] `--default-branch <branch>` 手動指定機能
  - [ ] テスト: 指定ブランチへの切り替え
  - [ ] テスト: 存在しないブランチの指定
- [ ] `--exclude <pattern>` パターン除外機能
  - [ ] テスト: 単一パターンの除外
  - [ ] テスト: 複数パターンの除外
  - [ ] テスト: 正規表現パターンの処理
- [ ] `--no-pull` プルスキップ機能
  - [ ] テスト: プル処理のスキップ確認
- [ ] `--force` 強制実行機能
  - [ ] テスト: 未マージブランチの強制削除
  - [ ] テスト: 通常削除との動作の違い

#### 4.2 設定管理
- [ ] 設定ファイル機能（.gitc.yml）
  - [ ] テスト: 設定ファイルの読み込み
  - [ ] テスト: 無効な設定のエラー処理
- [ ] グローバル設定とローカル設定
  - [ ] テスト: 設定の優先順位
- [ ] 除外パターンの永続化
  - [ ] テスト: 除外パターンの保存と読み込み

### Phase 5: エラーハンドリング・安全性 🛡️

#### 5.1 エラーケース対応
- [ ] 非Gitディレクトリでの実行時の分かりやすいエラー
  - [ ] テスト: エラーメッセージの内容確認
- [ ] リモートアクセス不可時の処理
  - [ ] テスト: オフライン時の動作
  - [ ] テスト: リモートURL未設定時の動作
- [ ] デフォルトブランチ検出失敗時の対処
  - [ ] テスト: フォールバック動作
  - [ ] テスト: ユーザーへの通知
- [ ] プルコンフリクト時の安全な中断
  - [ ] テスト: コンフリクト時の状態保持
- [ ] ブランチ削除失敗時の継続処理
  - [ ] テスト: 部分的な成功の処理

#### 5.2 安全性機能
- [ ] 保護ブランチリスト機能
  - [ ] テスト: デフォルト保護ブランチ
  - [ ] テスト: カスタム保護ブランチ
- [ ] 未マージコミット検出
  - [ ] テスト: 未マージコミットの警告
  - [ ] テスト: --forceでの上書き
- [ ] 削除前の最終確認強化
  - [ ] テスト: 重要な変更の警告表示

### Phase 6: 統合テスト・品質保証 🧪

#### 6.1 統合テスト
- [ ] エンドツーエンドテスト
  - [ ] テスト: 完全な実行フローのテスト
  - [ ] テスト: 各種オプションの組み合わせ
- [ ] モックを使った境界テスト
  - [ ] テスト: Git コマンドのモック
  - [ ] テスト: ファイルシステムのモック

#### 6.2 品質向上
- [ ] ベンチマークテスト追加
  - [ ] テスト: 大量ブランチでのパフォーマンス
- [ ] テストカバレッジ90%以上
- [ ] 静的解析ツール導入（golangci-lint）
- [ ] ドキュメントの自動生成

### Phase 7: 配布・デプロイ 📦

### ビルド・配布
- [ ] クロスプラットフォームビルド設定
- [ ] バイナリ最適化
- [ ] GitHub Actions CI/CD設定
- [ ] リリースプロセス自動化

### ドキュメント
- [ ] README.md 完成版
- [ ] インストール手順
- [ ] 使用例とチュートリアル
- [ ] トラブルシューティングガイド

---

## 開発ガイドライン

### コーディング規約
- Go の標準的な命名規則に従う
- エラーハンドリングは必須
- 関数は単一責任の原則に従う
- 適切なコメントを追加
- 空行にスペースのみを記載しない（完全な空行にする）
- コードコメントは平易な日本語で記述する

### テスト駆動開発（TDD）方針
- 新しい関数を実装する前に、まずテストを作成する
- 各機能の実装直後に対応するテストを必ず作成する
- テストファイルは同じパッケージ内に `*_test.go` として配置
- テストケースは以下を含める：
  - 正常系（期待される動作）
  - 異常系（エラーケース）
  - 境界値（エッジケース）
- テストカバレッジは80%以上を目標とする
- 統合テストは `integration` タグを使用して分離

### Git ワークフロー
- 機能ごとにブランチを作成
- 小さなコミットを心がける
- コミットメッセージは分かりやすく
- .git ディレクトリ以下のファイルは直接編集しない（Gitコマンドを使用する）
- 各Phaseごとに専用ブランチを作成し、Phase完了時にPull Requestを作成してマージする
  - 例: `phase3-cli-interface`、`phase4-advanced-features` など
  - Phase内でも必要に応じて機能ブランチを切る
- **重要**: 生成AIマーカー（🤖 Generated with [Claude Code]、Co-Authored-By: Claude）は不要
  - 自然なコミットメッセージを心がける
  - 開発者の意図を明確に表現する
  - AIアシスタンスを受けた場合でも、人間の開発者として自然なコミットを行う

### 優先順位
1. **Phase 1-2**: 基本機能を最優先で実装
2. **Phase 3**: ユーザビリティを重視
3. **Phase 4**: 高度な機能は後回し可能
4. **Phase 5-7**: 品質と安定性の確保

## 次のアクション

### 現在の状況
- Phase 1-2: ✅ 完了済み
- Phase 3.1: ✅ 完了済み（コア処理フロー）
- Phase 3.2: ✅ 完了済み（基本CLIインターフェース・最小実装）
- **最優先実装**: Phase 3.3 Fetch/Pull機能の追加

### Phase 3.3 実装戦略（完全なクリーンアップフロー）

#### 🎯 目標
**デフォルトブランチで最新の状態を取得してからクリーンアップを実行**

#### 📋 実装順序
1. **Fetch機能の追加**（最重要）
   - `git fetch --all --prune` を実行
   - リモートブランチの最新情報を取得
   
2. **Pull機能の有効化**
   - cmd/root.goの`NoPull: true`を削除
   - デフォルトブランチで最新変更を取得
   
3. **適切な実行順序の確保**
   - 切り替え → fetch → pull → 削除
   
4. **制御フラグの追加**
   - `--no-fetch`: fetch処理のスキップ
   - `--no-pull`: pull処理のスキップ

#### 🚀 実装方針
- **完全性**: リモートの最新状態を反映
- **安全性**: エラー時の適切な処理
- **柔軟性**: 必要に応じてスキップ可能

### 継続的改善
- 実装後の実際のコマンド実行テスト
- ユーザビリティの継続的改善
- 段階的な機能拡張
